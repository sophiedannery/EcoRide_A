{% extends 'base.html.twig' %}

{% block title %}Résultats de la recherche
{% endblock %}

{% block body %}

	<section class="py-5">
		<div class="container">
			<div class="row">
				<div
					class="col-12">

					{# Affichage recherche mobile #}
					<div class="d-lg-none rounded-3 shadow p-3 bg-white mb-3">
						<p class="mb-1 text-center">
							<i class="bi bi-search"></i>
							{{ app.request.query.get('depart')}}
							<i class="bi bi-arrow-right mx-1"></i>
							{{ app.request.query.get('arrivee')}}
						</p>
						<p class="text-muted text-center">{{ app.request.query.get('date')|date('d/m/Y')}}</p>
						<button class="btn btn-sm btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#searchFormCollapse" aria-expanded="true" aria-controls="searchFormCollapse">Modifier</button>
					</div>

				</div>
			</div>
		</div>
	</section>

	<section>
		<div class="container">

			<div class="row mb-5">
				<div class="col-12">
					<div class="d-sm-flex justify-content-sm-between align-items-center">
						<div class="mb-3 mb-sm-0">
							{% set resultCount = trajets|length %}
							<h1>{{ resultCount }}
								trajet{{ resultCount > 1 ? 's' : '' }}
								pour
								{{ app.request.query.get('depart')}}
								<i class="bi bi-arrow-right mx-1"></i>
								{{ app.request.query.get('arrivee')}}</h1>
						</div>
					</div>
				</div>
			</div>

			<div class="row">

				<div class="col-xl-4 col-xxl-3">

					<form method="GET" action="{{ path('app_search')}}">
						<div class="collapse d-lg-block rounded-3 shadow p-3 bg-white mb-5">
							<h4 class="mb-3">Ma recherche</h4>
							<div class="mb-4 px-3">
								<div class="form-check">
									<label id="depart" class="mb-1">
										<i class="bi bi-geo-alt me-2"></i>
										Départ</label>
									<input name="depart" type="text" class="form-control pe-4" required id="depart" value="{{ app.request.query.get('depart') }}">
								</div>
							</div>
							<div class="mb-4 px-3">
								<div class="form-check">
									<label id="depart" class="mb-1">
										<i class="bi bi-send me-2"></i>
										Arrivée</label>
									<input name="arrivee" type="text" class="form-control pe-4" required id="arrivee" value="{{ app.request.query.get('arrivee') }}">
								</div>
							</div>
							<div class="mb-4 px-3">
								<div class="form-check">
									<label id="depart" class="mb-1">
										<i class="bi bi-calendar me-2"></i>
										Date</label>
									<input name="date" type="date" class="form-control pe-4" required id="date" value="{{ app.request.query.get('date') }}">
								</div>
							</div>
							<div class="col-12 text-center pt-0">
								<button type="submit" class="btn btn-primary">Modifier ma recherche
									<i class="bi bi-arrow-right ps-3 text-white"></i>
								</button>
							</div>
						</div>
					</form>


					{# FILTRES #}
					<form id="filterFormDesktop">
						<div class="rounded-3 shadow p-3 bg-white mb-5">
							<h4 class="mb-3">Filtres</h4>
							<input type="hidden" name="depart" value="{{ app.request.query.get('depart') }}">
							<input type="hidden" name="arrivee" value="{{ app.request.query.get('arrivee') }}">
							<input type="hidden" name="date" value="{{ app.request.query.get('date') }}">

							<div class="mb-4 px-3">
								<div class="form-check">
									<label class="form-check-label" for="eco">
										Voyage écologique<i class="fa-solid fa-leaf ms-2"></i>
									</label>
									<input class="form-check-input" type="checkbox" name="eco" value="1">
								</div>
							</div>
							<div class="mb-4 px-3">
								<div class="flex items-center space-x-2">
									<i class="fa-solid fa-coins"></i>
									<label for="maxPrice" class="form-label">Prix max</label>
								</div>
								<input class="form-control" type="number" name="maxPrice" min="0">
							</div>
							<div class="mb-4 px-3">
								<div class="flex items-center space-x-2">
									<i class="fa-solid fa-hourglass-start"></i>
									<label for="maxDurationTime" class="form-label">Durée max</label>
								</div>
								<input class="form-control" type="time" name="maxDurationTime" step="60">
							</div>
							<div class="mb-4 px-3">
								<div class="flex items-center space-x-2">
									<i class="fa-solid fa-star"></i>
									<label for="minRating" class="form-label">Note minimal</label>
								</div>
								<input class="form-control" type="number" name="minRating" min="0" max="5" step="0.5">
							</div>

							<div>
								<a class="btn btn-link text-decoration-none text-muted" href="{{ path('app_search', { depart: app.request.query.get('depart'), arrivee: app.request.query.get('arrivee'), date: app.request.query.get('date') }) }}" class="btn btn-sm btn-link text-decoration-none">
									Effacer
								</a>
							</div>
						</div>


					</form>


				</div>

				<div class="col-xl-8 col-xxl-9">
					<div class="vstack gap-4" id="resultsContainer">


						{% include "partials/results_v2.html.twig" %}</div>
				</div>

			</div>


		</div>


	</section>


	<div class="text-center m-5">
		<a class="btn btn-outline-primary btn-lg px-4 me-md-2" href="/">Retour à l'accueil</a>
	</div>
{% endblock %}
{% block javascripts %}

	<script>
		document.addEventListener('DOMContentLoaded', function () {


const forms = document.querySelectorAll('#filterFormMobile, #filterFormDesktop');
const resultsContainer = document.getElementById('resultsContainer');

forms.forEach(form => {
form.querySelectorAll('input').forEach(input => {
input.addEventListener('change', () => {
const formData = new FormData(form);
const queryString = new URLSearchParams(formData).toString();

console.log("Query envoyée :", queryString);
resultsContainer.innerHTML = "<p>Chargement...</p>";

fetch('/search-ajax?' + queryString, {
headers: {
'X-Requested-With': 'XMLHttpRequest'
}
}).then(response => {
if (!response.ok) {
throw new Error("Erreur HTTP: " + response.status);
}
return response.text();
}).then(html => {
resultsContainer.innerHTML = html;
}).catch(error => {
resultsContainer.innerHTML = "<p>Erreur lors du chargement des trajets.</p>";
console.error('Erreur AJAX:', error);
});
});
});
});
});
	</script>
{% endblock %}
