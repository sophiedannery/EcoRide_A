{% extends 'base.html.twig' %}

{% block title %}Mon Espace
{% endblock %}

{#============================#
  On masque toutes les sections
  au chargement de la page.
#============================#}
{% block stylesheets %}
	{{ parent() }}
	<style>
		main section {
			display: none;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<div
			class="row">

			{#--------------------------#
			        COLONNE DE GAUCHE (SIDEBAR)
			      #--------------------------#}
			<aside class="col-3 p-0">
				<div
					class="d-flex flex-column flex-shrink-0 p-3 bg-body-tertiary" style="width: 280px;">
					{# Titre + logo #}
					<a href="{{ path('app_account') }}" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
						<svg class="bi pe-none me-2" width="40" height="32" aria-hidden="true">
							<use xlink:href="#bootstrap"></use>
						</svg>
						<span class="fs-4">Mon espace</span>
					</a>
					<hr>

					{# Menu #}
					<ul id="sidebar-nav" class="nav nav-pills flex-column mb-auto">
						<li class="nav-item">
							<a href="#profil" class="nav-link active" aria-current="page">
								<svg class="bi pe-none me-2" width="16" height="16" aria-hidden="true">
									<use xlink:href="#home"></use>
								</svg>
								Mon profil
							</a>
						</li>
						<li>
							<a href="#ajouter-trajet" class="nav-link link-body-emphasis">
								<svg class="bi pe-none me-2" width="16" height="16" aria-hidden="true">
									<use xlink:href="#speedometer2"></use>
								</svg>
								Ajouter un trajet
							</a>
						</li>
						<li>
							<a href="#vehicules" class="nav-link link-body-emphasis">
								<svg class="bi pe-none me-2" width="16" height="16" aria-hidden="true">
									<use xlink:href="#table"></use>
								</svg>
								Mes véhicules
							</a>
						</li>
						<li>
							<a href="#preferences" class="nav-link link-body-emphasis">
								<svg class="bi pe-none me-2" width="16" height="16" aria-hidden="true">
									<use xlink:href="#grid"></use>
								</svg>
								Mes préférences
							</a>
						</li>
						<li>
							<a href="#reservations" class="nav-link link-body-emphasis">
								<svg class="bi pe-none me-2" width="16" height="16" aria-hidden="true">
									<use xlink:href="#people-circle"></use>
								</svg>
								Mes réservations
							</a>
						</li>
						<li>
							<a href="#trajets" class="nav-link link-body-emphasis">
								<svg class="bi pe-none me-2" width="16" height="16" aria-hidden="true">
									<use xlink:href="#people-circle"></use>
								</svg>
								Mes trajets
							</a>
						</li>
					</ul>
					<hr>
				</div>
			</aside>

			{#--------------------------#
			        COLONNE DE DROITE (CONTENU)
			      #--------------------------#}
			<main
				class="col-9 py-4">

				{# Section PROFIL #}
				<section id="profil">
					<h1>Bonjour,
						{{ app.user.pseudo }}
						!</h1>
					<p>
						<strong>Statut :</strong>
						{{ app.user.statut }}
					</p>
					{{ form_start(statutForm) }}
					{{ form_widget(statutForm) }}
					<button class="btn btn-primary">Mettre à jour votre statut</button>
					{{ form_end(statutForm) }}
					<hr>
					<p>Vous avez actuellement
						<strong>{{ app.user.credits }}</strong>
						crédits.</p>

					{% if app.user.photoFilename %}
						<div>
							<img src="{{ asset('uploads/photos/' ~ app.user.photoFilename) }}" alt="Photo de profil de {{ app.user.pseudo }}" style="width:150px; height:150px; object-fit:cover; border-radius:50%;">
						</div>
						<a href="{{ path('app_account_edit') }}" class="btn btn-outline-primary">Modifier ma photo</a>
					{% else %}
						<p>Aucune photo de profil enregistrée.</p>
						<a href="{{ path('app_account_edit') }}" class="btn btn-outline-primary">Ajouter une photo</a>
					{% endif %}
				</section>

				{# Section AJOUT TRAJET #}
				<section id="ajouter-trajet" class="mt-5">
					<h2>Ajouter un trajet</h2>
					<a href="{{ path('account_trajet_new') }}" class="btn btn-success mb-4">Nouveau trajet</a>
				</section>

				{# Section VÉHICULES #}
				<section id="vehicules" class="mt-5">
					<h2>Mes véhicules</h2>
					<a href="{{ path('app_account_vehicule_new') }}" class="btn btn-primary mb-3">Ajouter une voiture</a>
					{% if vehicules is empty %}
						<p>Vous n'avez pas encore de véhicule enregistré.</p>
					{% else %}
						<table class="table">
							<thead>
								<tr>
									<th>Plaque</th>
									<th>1ère immat.</th>
									<th>Marque</th>
									<th>Modèle</th>
									<th>Couleur</th>
									<th>Places</th>
									<th>Énergie</th>
								</tr>
							</thead>
							<tbody>
								{% for v in vehicules %}
									<tr>
										<td>{{ v.immatriculation }}</td>
										<td>{{ v.datePremiereImmatriculation|date('d/m/Y') }}</td>
										<td>{{ v.marque }}</td>
										<td>{{ v.modele }}</td>
										<td>{{ v.couleur }}</td>
										<td>{{ v.placesDisponibles }}</td>
										<td>{{ v.energie }}</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					{% endif %}
				</section>

				{# Section PRÉFÉRENCES #}
				<section id="preferences" class="mt-5">
					<h2>Mes préférences</h2>
					{% if app.user.preferences is empty %}
						<p>Aucune préférence définie.</p>
					{% else %}
						<ul>
							{% for p in app.user.preferences %}
								<li>{{ p.libelle }}</li>
							{% endfor %}
						</ul>
					{% endif %}
					<a href="{{ path('app_account_preferences') }}" class="btn btn-outline-primary">Modifier mes préférences</a>
				</section>

				{# Section RÉSERVATIONS #}
				<section id="reservations" class="mt-5">
					{% if history is empty %}
						<p>Vous n'avez aucune réservation pour le moment.</p>
					{% else %}
						<table class="table table-striped">
							<thead>
								<tr>
									<th>Trajet</th>
									<th>Date de départ</th>
									<th>Statut</th>
									<th>Crédits utilisés</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody>
								{% for r in history %}
									<tr>
										<td>
											{{ r.adresse_depart }}
											→
											{{ r.adresse_arrivee }}<br>
											Chauffeur :
											{{ r.chauffeur_pseudo }}
										</td>
										<td>{{ r.date_depart|date('d/m/Y H:i') }}</td>
										<td>{{ r.reservation_statut }}</td>
										<td>{{ r.credits_utilises }}</td>
										<td>
											{% if r.reservation_statut == 'confirmée' %}
												<form method="post" action="{{ path('app_reservation_annuler', {'id': r.reservation_id}) }}" onsubmit="return confirm('Voulez-vous vraiment annuler cette réservation ?')">
													<input type="hidden" name="_token" value="{{ csrf_token('cancel_reservation' ~ r.reservation_id) }}">
													<button class="btn btn-sm btn-danger">Annuler</button>
												</form>
											{% endif %}
											{% if r.reservation_statut == 'confirmée' and r.statut_trajet == 'terminé' %}
												<form method="post" action="{{ path('app_reservation_valider', {'id': r.reservation_id}) }}" onsubmit="return confirm('Tout s\\'est bien passé ? Validez pour payer le chauffeur.')">
													<input type="hidden" name="_token" value="{{ csrf_token('reservation_valider' ~ r.reservation_id) }}">
													<button class="btn btn-sm btn-success">Valider</button>
												</form>
											{% endif %}
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					{% endif %}
				</section>

				{# Section TRAJETS #}
				<section id="trajets" class="mt-5">
					<h2>Mes trajets en tant que chauffeur</h2>
					{% if driverTrips is empty %}
						<p>Vous n'avez créé aucun trajet pour le moment.</p>
					{% else %}
						<table class="table table-striped">
							<thead>
								<tr>
									<th>Départ → Arrivée</th>
									<th>Date départ</th>
									<th>Prix</th>
									<th>Places</th>
									<th>Statut</th>
									<th>Passagers</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody>
								{% for t in driverTrips %}
									<tr>
										<td>{{ t.adresse_depart }}
											→
											{{ t.adresse_arrivee }}</td>
										<td>{{ t.date_depart|date('d/m/Y H:i') }}</td>
										<td>{{ t.prix }}
											crédits</td>
										<td>{{ t.places_restantes }}</td>
										<td>
											{# boutons “Démarrer”, “Arrivée” etc. #}
											{% set departDate = t.date_depart[:10] %}
											{% set today = 'now'|date('Y-m-d') %}
											{% if t.statut_trajet == 'confirmé' and departDate == today %}
												<form method="post" action="{{ path('app_trajet_demarrer', {'id': t.id_trajet}) }}" onsubmit="return confirm('Voulez-vous démarrer ce trajet ?')">
													<input type="hidden" name="_token" value="{{ csrf_token('trajet_demarrer' ~ t.id_trajet) }}">
													<button class="btn btn-sm btn-primary">Démarrer</button>
												</form>
											{% elseif t.statut_trajet == 'confirmé' and departDate != today %}
												<button class="btn btn-sm btn-primary" disabled>Démarrer</button>
											{% endif %}
											{% if t.statut_trajet == 'en_cours' %}
												<form method="post" action="{{ path('app_trajet_arriver', {'id': t.id_trajet}) }}" onsubmit="return confirm('Êtes-vous arrivé à destination ?')">
													<input type="hidden" name="_token" value="{{ csrf_token('trajet_arriver' ~ t.id_trajet) }}">
													<button class="btn btn-sm btn-success">Arrivée à destination</button>
												</form>
											{% endif %}
											{% if t.statut_trajet == 'terminé' %}
												<button class="btn btn-sm btn-success" disabled>En attente de validation</button>
											{% endif %}
											{% if t.statut_trajet == 'validé' %}
												<button class="btn btn-sm btn-success" disabled>Trajet terminé</button>
											{% endif %}
										</td>
										<td>
											{% if t.passagers is empty %}
												<em>Aucun passager</em>
											{% else %}
												{{ t.passagers|join(', ') }}
											{% endif %}
										</td>
										<td>
											{% if t.statut_trajet is not same as('annulé') %}
												<form method="post" action="{{ path('app_trajet_annuler', {'id': t.id_trajet}) }}" onsubmit="return confirm('Annuler définitivement ce trajet et rembourser tous les passagers ?')">
													<input type="hidden" name="_token" value="{{ csrf_token('cancel_trajet' ~ t.id_trajet) }}">
													<button class="btn btn-sm btn-danger">Annuler le trajet</button>
												</form>
											{% endif %}
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					{% endif %}
				</section>

			</main>
		</div>
	</div>
{% endblock %}


{#===============================#
  Bloc JavaScript : on attend bien
  le DOMContentLoaded pour exécuter
  l’affichage/masquage de sections.
#===============================#}
{% block javascripts %}
	{{ parent() }}
	<script>
		document.addEventListener('DOMContentLoaded', function () { // Fonction qui affiche UNE SEULE section et en cache les autres
function afficherSection(idCible) {
document.querySelectorAll('main section').forEach(function (sec) {
sec.style.display = (sec.id === idCible) ? 'block' : 'none';
});
}

// Récupère tous les liens <a> de la sidebar
const liens = document.querySelectorAll('#sidebar-nav a.nav-link');

// 1. Au chargement, affiche la section “profil”
afficherSection('profil');

// 2. Pour chaque lien, on intercepte le clic
liens.forEach(function (lien) {
lien.addEventListener('click', function (e) {
const href = this.getAttribute('href');
if (! href || ! href.startsWith('#')) {
return;
}
e.preventDefault();
const cible = href.substring(1);
if (document.getElementById(cible)) {
afficherSection(cible);
// Met à jour la classe “active” sur le lien
liens.forEach(l => l.classList.remove('active'));
this.classList.add('active');
}
});
});
});
	</script>
{% endblock %}
