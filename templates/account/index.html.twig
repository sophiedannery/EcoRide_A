{% extends 'base.html.twig' %}

{% block title %}Mon Espace
{% endblock %}

{% block body %}

<h1>Bonjour,
	{{app.user.pseudo}}
	!
</h1>

<p>Staut :
	{{ app.user.statut}}</p>

{{ form_start(statutForm) }}
{{ form_widget(statutForm) }}
<button class="btn btn-primary">Mettre à jour votre statut</button>
{{ form_end(statutForm) }}


<p>Vous avez actuellement
	{{ app.user.credits }}
	crédits.
</p>


<h2>Ajouter un trajet</h2>
<a href="{{ path('account_trajet_new')}}" class="btn btn-success mb-4">Nouveau trajet</a>

<h2>Mes véhicules</h2>

<a href="{{ path('app_account_vehicule_new')}}" class="btn btn-primary mb-3">Ajouter une voiture</a>

{% if vehicules is empty %}
	<p>Vous n'avez pas encore de véhicule enregistré.</p>
{% else %}

	<table class="table">
		<thead>
			<tr>
				<th>Plaque</th>
				<th>1ère immat.</th>
				<th>Marque</th>
				<th>Modèle</th>
				<th>Couleur</th>
				<th>Places</th>
				<th>Energie</th>
			</tr>
		</thead>
		<tbody>
			{% for v in vehicules %}
				<tr>
					<td>{{ v.immatriculation }}</td>
					<td>{{ v.datePremiereImmatriculation|date('d/m/Y') }}</td>
					<td>{{ v.marque }}</td>
					<td>{{ v.modele }}</td>
					<td>{{ v.couleur }}</td>
					<td>{{ v.placesDisponibles }}</td>
					<td>{{ v.energie }}</td>

				</tr>
			{% endfor %}
		</tbody>
	</table>

{% endif %}


<h2>Mes préférences</h2>

{% if app.user.preferences is empty %}
	<p>Aucune préférence définie.</p>
{% else %}
	<ul>
		{% for p in app.user.preferences %}
			<li>{{ p.libelle }}</li>
		{% endfor %}
	</ul>
{% endif %}
<a href="{{ path('app_account_preferences')}}" class="btn btn-outline-primary">Modifier mes préférences</a>


<h2>Mon historique de réservation</h2>

{% if history is empty %}
	<p>Vous n'avez aucune réservation pour le moment.</p>
{% else %}

	<table class="table table-striped">
		<thead>
			<tr>
				<th>Trajet</th>
				<th>Date de départ</th>
				<th>Statut</th>
				<th>Crédits utilisés</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody>
			{% for r in history %}
				<tr>
					<td>
						{{ r.adresse_depart }}
						→
						{{ r.adresse_arrivee }}
						<br>
						Chauffeur :
						{{ r.chauffeur_pseudo }}
					</td>
					<td>{{ r.date_depart|date('d/m/Y H:i') }}</td>
					<td>{{ r.reservation_statut }}</td>
					<td>{{ r.credits_utilises }}</td>
					<td>
						{% if r.reservation_statut == 'confirmée' %}
							<form method='post' action="{{ path('app_reservation_annuler', {'id': r.reservation_id}) }}" onsubmit="return confirm('Voulez-vous vraiment annuler cette réservation ?')" ;>
								<input type="hidden" name="_token" value="{{ csrf_token('cancel_reservation' ~ r.reservation_id) }}">
								<button class="btn btn-sm btn-danger">Annuler</button>
							</form>
						{% endif %}
					</td>
				</tr>
			{% endfor %}
		</tbody>
	</table>
{% endif %}


<h2>Mes trajets en tant que chauffeur</h2>
{% if driverTrips is empty %}
	<p>Vous n'avez créé aucun trajet pour le moment.</p>
{% else %}
	<table class="table table-striped">
		<thead>
			<tr>
				<th>Départ → Arrivée</th>
				<th>Date départ</th>
				<th>Prix</th>
				<th>Places</th>
				<th>Statut</th>
				<th>Passagers</th>
				<th>Statut</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody>
			{% for t in driverTrips %}
				<tr>
					<td>{{ t.adresse_depart }}
						→
						{{ t.adresse_arrivee }}</td>
					<td>{{ t.date_depart }}</td>
					<td>{{ t.prix }}
						crédits</td>
					<td>{{ t.places_restantes }}</td>
					<td>{{ t.statut_trajet }}</td>
					<td>
						{% if t.passagers is empty %}
							<em>Aucun passager</em>
						{% else %}
							{{ t.passagers|join(', ')}}
						{% endif %}
					</td>
					<td>

						{% set departDate = t.date_depart[:10] %}
						{% set today = 'now'|date('Y-m-d') %}


						{% if t.statut_reel == 'confirmé' and departDate == today %}
							<form method='post' action="{{ path('app_trajet_demarrer', {'id': t.id_trajet}) }}" onsubmit="return confirm('Voulez-vous démarrer ce trajet ?')" ;>
								<input type="hidden" name="_token" value="{{ csrf_token('trajet_demarrer' ~ t.id_trajet) }}">
								<button class="btn btn-sm btn-primary">Démarrer</button>
							</form>
						{% elseif t.statut_reel == 'confirmé' and departDate != today %}
							<button class="btn btn-sm btn-primary" disabled>Démarrer</button>
						{% endif %}

						{% if t.statut_reel == 'en_cours' %}
							<form method='post' action="{{ path('app_trajet_arriver', {'id': t.id_trajet}) }}" onsubmit="return confirm('Êtes-vous arrivé à destination ?')" ;>
								<input type="hidden" name="_token" value="{{ csrf_token('trajet_arriver' ~ t.id_trajet) }}">
								<button class="btn btn-sm btn-success">Arrivée à destination</button>
							</form>
						{% endif %}

						{% if t.statut_reel == 'terminé' %}
							<button class="btn btn-sm btn-success" disabled>En attente de validation</button>
						{% endif %}

						{% if t.statut_reel == 'validé' %}
							<button class="btn btn-sm btn-success" disabled>Trajet terminé</button>
						{% endif %}
					</td>
				</tr>
			</p>
		</tbody>
	</td>
	<td>

		{% if t.statut_trajet is not same as('annulé')%}
			<form method='post' action="{{ path('app_trajet_annuler', {'id': t.id_trajet}) }}" onsubmit="return confirm('Annuler définitivement ce trajet et rembourser tous les passagers ?')" ;>
				<input type="hidden" name="_token" value="{{ csrf_token('cancel_trajet' ~ t.id_trajet) }}">
				<button class="btn btn-sm btn-danger">Annuler le trajet</button>
			</form>
		{% endif %}

	</td>
</tr>{% endfor %}</tbody></table>{% endif %}{% endblock %}
